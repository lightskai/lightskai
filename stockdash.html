<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dow 30 MarketPulse - Real-Time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --text-main: #F1F5F9;
            --text-muted: #94A3B8;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-blue: #3B82F6;
            --accent-orange: #F59E0B;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span { color: var(--accent-blue); }

        .live-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100%;
            overflow: hidden;
        }

        /* Controls Sidebar */
        .controls-panel {
            grid-row: 1 / -1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .slider-value { color: var(--accent-blue); font-weight: 600; }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-blue);
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            margin-top: -6px; 
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
        }

        select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
        }

        /* Search Input Styles */
        .search-container {
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .search-btn {
            background: var(--bg-hover);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 12px;
            cursor: not-allowed;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .btn-refresh {
            background: var(--bg-hover);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            margin-top: auto;
        }

        .btn-refresh:hover { background: #475569; }
        
        .btn-refresh:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-refresh:disabled:hover {
            background: var(--bg-hover);
        }

        /* Main Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Table Styles */
        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        th:hover { background: rgba(255,255,255,0.05); }
        th.active-sort { color: var(--accent-blue); }
        .sort-icon { margin-left: 4px; }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            font-size: 0.875rem;
        }

        tr:hover { background: rgba(255,255,255,0.02); }

        .ticker-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 0.95rem;
        }

        .company-name {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: block;
        }

        .val-green { color: var(--accent-green); }
        .val-red { color: var(--accent-red); }

        .iv-badge {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .iv-low { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .iv-med { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        .iv-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        /* Range Bar */
        .range-container {
            position: relative;
            width: 100%;
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: visible;
        }

        .range-track {
            position: absolute;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red) 0%, var(--accent-orange) 50%, var(--accent-green) 100%);
            border-radius: 3px;
            width: 100%;
        }

        .range-marker {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        .chart-card { grid-column: span 2; }
        .chart-canvas { height: 100%; width: 100%; }

        .status-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">Dow 30 <span>MarketPulse</span></div>
        <div class="live-badge">
            <div class="live-dot"></div>
            LIVE
        </div>
    </header>

    <div class="dashboard-grid">
        
        <!-- Left: Controls Panel -->
        <aside class="controls-panel">
            <div class="control-group">
                <label class="control-label">
                    <span>üìâ Max Drop</span>
                    <span class="slider-value" id="dropValue">0%</span>
                </label>
                <input type="range" id="dropSlider" min="0" max="20" value="0" step="0.5">
            </div>

            <div class="control-group">
                <label class="control-label">
                    <span>üìä Min Volatility</span>
                    <span class="slider-value" id="ivValue">0%</span>
                </label>
                <input type="range" id="ivSlider" min="0" max="10" value="0" step="0.1">
            </div>

            <div class="control-group">
                <label class="control-label">Market Cap</label>
                <select id="marketCapSelect">
                    <option value="all">All Sizes</option>
                    <option value="large">Large (>100B)</option>
                    <option value="mid">Mid (10-100B)</option>
                    <option value="small">Small (<10B)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Timeframe</label>
                <select id="timeframeSelect">
                    <option value="1D">1 Day</option>
                    <option value="5D">5 Days</option>
                    <option value="1M">1 Month</option>
                    <option value="6M">6 Months</option>
                    <option value="YTD">Year to Date</option>
                    <option value="1Y">1 Year</option>
                    <option value="5Y">5 Years</option>
                    <option value="MAX">Max</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Filter Symbol (Dow 30 only)</label>
                <div class="search-container">
                    <input type="text" id="symbolInput" class="search-input" placeholder="e.g. AAPL" maxlength="5">
                </div>
            </div>

            <button id="refreshBtn" class="btn-refresh">üîç Fetch Data</button>
            
            <div class="status-text" id="statusText">Ready - Click Fetch Data to load</div>
        </aside>

        <!-- Right Top: Data Table -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìà Dow 30 Stocks</h2>
                <span class="status-text">Results: <strong id="resultCount">0</strong></span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-key="symbol">Symbol <span class="sort-icon"></span></th>
                            <th data-key="price" style="text-align: right;">Live Price <span class="sort-icon"></span></th>
                            <th data-key="change" class="active-sort" style="text-align: right;">% Change <span class="sort-icon">‚ñ≤</span></th>
                            <th data-key="iv" style="text-align: center;">Day Volatility <span class="sort-icon"></span></th>
                            <th data-key="range">52 Week Range (Position) <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center; padding:40px; color: var(--text-muted);">
                            Click <strong style="color: var(--accent-blue);">Fetch Data</strong> button to load market data
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Bottom: Scatter Chart -->
        <div class="card chart-card">
            <div class="card-header">
                <h2 class="card-title">üìä Return vs Volatility Matrix</h2>
            </div>
            <canvas id="scatterChart" class="chart-canvas"></canvas>
        </div>

    </div>

    <script>
        // ==========================================
        // 1. API CONFIGURATION
        // ==========================================
        const API_KEY = 'CsC37moTEOy5wF0yLpwBjDZJorOAaPXD';
        const BASE_URL = 'https://financialmodelingprep.com/api/v3';
        
        // Use single reliable CORS proxy
        const USE_PROXY = true;
        const PROXY_URL = 'https://api.allorigins.win/get?url=';
        
        // Dow 30 symbols
        const DOW30_SYMBOLS = [
            'AAPL', 'MSFT', 'JPM', 'V', 'UNH', 'HD', 'PG', 'JNJ', 'DIS', 'MA',
            'NVDA', 'BAC', 'XOM', 'PFE', 'CSCO', 'ADBE', 'CRM', 'NKE', 'MRK',
            'WMT', 'KO', 'CVX', 'TMO', 'ABBV', 'PEP', 'LLY', 'COST', 'ACN', 'AVGO', 'DHR'
        ];

        // ==========================================
        // 2. STATE & DOM REFERENCES
        // ==========================================
        let marketData = [];
        let sortState = { key: 'change', direction: 'asc' };
        let scatterChart = null;

        const tbody = document.getElementById('tableBody');
        const dropSlider = document.getElementById('dropSlider');
        const ivSlider = document.getElementById('ivSlider');
        const marketCapSelect = document.getElementById('marketCapSelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const symbolInput = document.getElementById('symbolInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const resultCount = document.getElementById('resultCount');
        const statusText = document.getElementById('statusText');
        const tableHeaders = document.querySelectorAll('th[data-key]');

        dropSlider.addEventListener('input', e => {
            document.getElementById('dropValue').textContent = `${e.target.value}%`;
        });
        ivSlider.addEventListener('input', e => {
            document.getElementById('ivValue').textContent = `${e.target.value}%`;
        });

        // ==========================================
        // 3. API FUNCTIONS
        // ==========================================

        /**
         * Fetch real-time quotes for all Dow 30 stocks
         */
        async function fetchMarketData() {
            try {
                statusText.textContent = 'Fetching market data...';
                const symbolsParam = DOW30_SYMBOLS.join(',');
                const apiUrl = `${BASE_URL}/quote/${symbolsParam}?apikey=${API_KEY}`;
                
                // Use proxy to bypass CORS
                const url = USE_PROXY ? `${PROXY_URL}${encodeURIComponent(apiUrl)}` : apiUrl;
                
                console.log('Fetching from:', apiUrl);
                console.log('Using proxy:', USE_PROXY);
                
                const response = await fetch(url, {
                    method: 'GET'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseData = await response.json();
                
                // AllOrigins wraps the response in a 'contents' field
                let data;
                if (responseData.contents) {
                    data = JSON.parse(responseData.contents);
                } else if (responseData.status && responseData.status.url) {
                    // Another AllOrigins format
                    data = JSON.parse(responseData.contents);
                } else {
                    data = responseData;
                }
                
                console.log('Received data:', data);
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('No data received from API. Check console for details.');
                }
                
                statusText.textContent = `‚úì Last updated: ${new Date().toLocaleTimeString()} | ${data.length} stocks loaded`;
                return data;
                
            } catch (error) {
                console.error('Full error:', error);
                statusText.innerHTML = `<span style="color: var(--accent-red);">‚ö† Error: ${error.message}</span>`;
                
                // Remove old error messages
                const oldError = document.querySelector('.error-message');
                if (oldError) oldError.remove();
                
                // Show helpful message
                const helpDiv = document.createElement('div');
                helpDiv.className = 'error-message';
                helpDiv.innerHTML = `
                    <strong>Troubleshooting Steps:</strong><br>
                    1. Check browser console (F12) for detailed errors<br>
                    2. Upload and use api-diagnostics.html to test connectivity<br>
                    3. Verify your API key at financialmodelingprep.com<br>
                    4. Try uploading api-proxy.php for server-side proxy
                `;
                statusText.parentElement.appendChild(helpDiv);
                
                return null;
            }
        }

        /**
         * Fetch historical data for a single symbol
         */
        async function fetchHistoricalData(symbol) {
            try {
                const apiUrl = `${BASE_URL}/historical-price-full/${symbol}?apikey=${API_KEY}`;
                const url = USE_PROXY ? `${PROXY_URL}${encodeURIComponent(apiUrl)}` : apiUrl;
                
                const response = await fetch(url, {
                    method: 'GET'
                });
                
                if (!response.ok) {
                    console.error(`Failed to fetch historical data for ${symbol}`);
                    return null;
                }
                
                const responseData = await response.json();
                
                // Handle AllOrigins wrapper
                let data;
                if (responseData.contents) {
                    data = JSON.parse(responseData.contents);
                } else {
                    data = responseData;
                }
                
                if (!data.historical || data.historical.length === 0) {
                    return null;
                }
                
                const hist = data.historical;
                const current = hist[0].close;
                
                // Calculate percentage changes for different timeframes
                const getChange = (daysAgo) => {
                    if (hist.length <= daysAgo) return 0;
                    const pastPrice = hist[daysAgo].close;
                    return ((current - pastPrice) / pastPrice) * 100;
                };
                
                // Calculate YTD
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const ytdIndex = hist.findIndex(h => new Date(h.date) <= startOfYear);
                const ytdChange = ytdIndex > 0 ? ((current - hist[ytdIndex].close) / hist[ytdIndex].close) * 100 : 0;
                
                return {
                    '5D': getChange(5),
                    '1M': getChange(21),
                    '6M': getChange(126),
                    'ytd': ytdChange,
                    '1Y': getChange(252),
                    '5Y': getChange(1260),
                    'max': hist.length > 1 ? ((current - hist[hist.length - 1].close) / hist[hist.length - 1].close) * 100 : 0
                };
                
            } catch (error) {
                console.error(`Error fetching historical data for ${symbol}:`, error);
                return null;
            }
        }

        /**
         * Transform API data into our internal format
         */
        function transformMarketData(apiData) {
            return apiData.map(stock => ({
                symbol: stock.symbol,
                name: stock.name || stock.symbol,
                price: stock.price || 0,
                change: stock.changesPercentage || 0,
                volume: stock.volume || 0,
                marketCap: stock.marketCap || 0,
                yearHigh: stock.yearHigh || stock.price,
                yearLow: stock.yearLow || stock.price,
                dayHigh: stock.dayHigh || stock.price,
                dayLow: stock.dayLow || stock.price,
                // Calculate intraday volatility as a proxy
                iv: stock.dayHigh && stock.dayLow && stock.price 
                    ? ((stock.dayHigh - stock.dayLow) / stock.price) * 100 
                    : 0,
                timeframes: {} // Will be populated on-demand
            }));
        }

        /**
         * Main function to refresh all market data
         */
        async function refreshMarketData() {
            const apiData = await fetchMarketData();
            
            if (!apiData) {
                // Keep existing data if fetch fails
                return;
            }
            
            marketData = transformMarketData(apiData);
            await filterAndRender();
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function formatMarketCap(cap) {
            if (!cap) return 'N/A';
            if (cap >= 1e12) return `$${(cap / 1e12).toFixed(1)}T`;
            if (cap >= 1e9) return `$${(cap / 1e9).toFixed(1)}B`;
            if (cap >= 1e6) return `$${(cap / 1e6).toFixed(1)}M`;
            return `$${cap.toFixed(0)}`;
        }

        function initChart() {
            const ctx = document.getElementById('scatterChart').getContext('2d');
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Stocks',
                        data: [],
                        backgroundColor: function(context) {
                            const value = context.raw.x;
                            return value >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)';
                        },
                        borderColor: function(context) {
                            const value = context.raw.x;
                            return value >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                        },
                        pointRadius: 6,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    scales: {
                        x: { 
                            title: { display: true, text: '% Change', color: '#94A3B8' }, 
                            grid: { color: '#1E293B' },
                            ticks: { color: '#94A3B8' }
                        },
                        y: { 
                            title: { display: true, text: 'Daily Volatility %', color: '#94A3B8' }, 
                            beginAtZero: true, 
                            grid: { color: '#334155' },
                            ticks: { color: '#94A3B8' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.symbol}: ${context.raw.x.toFixed(2)}% (Vol: ${context.raw.y.toFixed(2)}%)`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        function renderTable(data, selectedTimeframe) {
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No stocks match the current filters</td></tr>`;
                return;
            }

            data.forEach(stock => {
                let currentChange = 0;
                if(selectedTimeframe === '1D') {
                    currentChange = stock.change;
                } else if (stock.timeframes && stock.timeframes[selectedTimeframe]) {
                    currentChange = stock.timeframes[selectedTimeframe].change;
                }

                const rangeTotal = stock.yearHigh - stock.yearLow;
                const safeRange = rangeTotal === 0 ? 1 : rangeTotal;
                const position = ((stock.price - stock.yearLow) / safeRange) * 100;
                const clampedPos = Math.max(0, Math.min(100, position));

                let ivClass = 'iv-low';
                if(stock.iv > 1.5) ivClass = 'iv-med';
                if(stock.iv > 3.0) ivClass = 'iv-high';
                
                const changeColor = currentChange >= 0 ? 'val-green' : 'val-red';
                const sign = currentChange > 0 ? '+' : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="ticker-cell">${stock.symbol}</div>
                        <span class="company-name" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${stock.name}</span>
                    </td>
                    <td style="text-align: right;">$${stock.price.toFixed(2)}</td>
                    <td style="text-align: right;" class="${changeColor}">${sign}${currentChange.toFixed(2)}%</td>
                    <td style="text-align: center;">
                        <span class="iv-badge ${ivClass}">${stock.iv.toFixed(2)}%</span>
                    </td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94A3B8; margin-bottom:2px;">
                            <span>L: ${stock.yearLow ? stock.yearLow.toFixed(0) : 'N/A'}</span>
                            <span>${formatMarketCap(stock.marketCap)}</span>
                            <span>H: ${stock.yearHigh ? stock.yearHigh.toFixed(0) : 'N/A'}</span>
                        </div>
                        <div class="range-container">
                            <div class="range-track"></div>
                            <div class="range-marker" style="left: ${clampedPos}%" title="Current Price"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function filterAndRender() {
            const filterTerm = symbolInput.value.toUpperCase().trim();
            const currentTimeframe = timeframeSelect.value; 
            const minDrop = parseFloat(dropSlider.value);
            const minIV = parseFloat(ivSlider.value);
            const capType = marketCapSelect.value;

            let filtered = [...marketData];

            // 1. Local Filter (Dow 30 Only)
            if (filterTerm.length > 0) {
                filtered = filtered.filter(s => s.symbol.includes(filterTerm));
            }

            // 2. Handle History (Lazy Load with Caching)
            if(currentTimeframe !== '1D') {
                for (let stock of filtered) {
                    // API OPTIMIZATION: Only fetch if we don't have it yet
                    if (!stock.timeframes[currentTimeframe]) {
                        const hist = await fetchHistoricalData(stock.symbol);
                        if(hist) {
                            stock.timeframes['5D'] = { change: hist['5D'] };
                            stock.timeframes['1M'] = { change: hist['1M'] };
                            stock.timeframes['6M'] = { change: hist['6M'] };
                            stock.timeframes['YTD'] = { change: hist['ytd'] };
                            stock.timeframes['1Y'] = { change: hist['1Y'] };
                            stock.timeframes['5Y'] = { change: hist['5Y'] };
                            stock.timeframes['MAX'] = { change: hist['max'] };
                        }
                    }
                }
            }

            // 3. Filter Logic
            filtered = filtered.filter(stock => {
                let changeToCheck = stock.change; 
                if(currentTimeframe !== '1D' && stock.timeframes[currentTimeframe]) {
                    changeToCheck = stock.timeframes[currentTimeframe].change;
                }

                const meetsDrop = changeToCheck <= (minDrop === 0 ? 1000 : minDrop);
                const meetsIV = stock.iv >= minIV;
                
                let meetsCap = true;
                if(stock.marketCap) {
                    const capB = stock.marketCap / 1000000000;
                    if(capType === 'large') meetsCap = capB > 100;
                    if(capType === 'mid') meetsCap = capB >= 10 && capB <= 100;
                    if(capType === 'small') meetsCap = capB < 10;
                }

                return meetsDrop && meetsIV && meetsCap;
            });

            // 4. Sort
            filtered.sort((a, b) => {
                let valA, valB;
                
                if (sortState.key === 'change') {
                     valA = currentTimeframe === '1D' ? a.change : (a.timeframes[currentTimeframe]?.change || 0);
                     valB = currentTimeframe === '1D' ? b.change : (b.timeframes[currentTimeframe]?.change || 0);
                } else if (sortState.key === 'range') {
                     const rA = (a.yearHigh - a.yearLow) || 1;
                     valA = (a.price - a.yearLow) / rA;
                     const rB = (b.yearHigh - b.yearLow) || 1;
                     valB = (b.price - b.yearLow) / rB;
                } else {
                    valA = a[sortState.key];
                    valB = b[sortState.key];
                }

                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            resultCount.textContent = filtered.length;
            renderTable(filtered, currentTimeframe);

            // Only update chart if we have valid data
            if (filtered.length > 0) {
                const chartData = filtered.map(s => ({
                    x: currentTimeframe === '1D' ? s.change : (s.timeframes[currentTimeframe]?.change || 0),
                    y: s.iv,
                    symbol: s.symbol
                }));
                scatterChart.data.datasets[0].data = chartData;
                scatterChart.options.scales.x.title.text = `% Change (${currentTimeframe})`;
                scatterChart.update();
            } else {
                // Clear chart if no data
                scatterChart.data.datasets[0].data = [];
                scatterChart.update();
            }
        }

        // ==========================================
        // 4. EVENT LISTENERS
        // ==========================================

        tableHeaders.forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.direction = key === 'change' ? 'asc' : 'desc';
                }
                tableHeaders.forEach(h => {
                    h.classList.remove('active-sort');
                    h.querySelector('.sort-icon').textContent = '';
                });
                th.classList.add('active-sort');
                th.querySelector('.sort-icon').textContent = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                filterAndRender();
            });
        });

        // Filter input (Manual fetch only - no auto-update)
        // Removed: symbolInput.addEventListener('keyup', filterAndRender);

        // Removed auto-update on slider/select changes
        // User must click Fetch Data button to apply filters

        refreshBtn.addEventListener('click', async () => {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Fetching...';
            
            await refreshMarketData();
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîç Fetch Data';
        });

        // ==========================================
        // 5. INITIALIZATION
        // ==========================================

        // Removed automatic polling - user must click Fetch Data button
        // No startPolling() function needed

        initChart();
        // Removed: refreshMarketData() - don't auto-fetch on page load
        // Removed: startPolling() - no automatic refresh 

    </script>
</body>
</html>
