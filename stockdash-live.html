<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dow 30 MarketPulse - Real-Time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --text-main: #F1F5F9;
            --text-muted: #94A3B8;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-blue: #3B82F6;
            --accent-orange: #F59E0B;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span { color: var(--accent-blue); }

        .live-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            flex: 1;
            overflow: hidden;
        }

        .controls-panel {
            grid-row: 1 / -1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .slider-value { color: var(--accent-blue); font-weight: 600; }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-blue);
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            margin-top: -6px; 
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
        }

        select, .search-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
        }

        .search-input {
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }
        
        .btn-refresh {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            margin-top: auto;
        }

        .btn-refresh:hover { background: #2563eb; }
        
        .btn-refresh:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        th:hover { background: rgba(255,255,255,0.05); }
        th.active-sort { color: var(--accent-blue); }
        .sort-icon { margin-left: 4px; }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            font-size: 0.875rem;
        }

        tr:hover { background: rgba(255,255,255,0.02); }

        .ticker-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-blue);
            font-size: 0.95rem;
        }

        .company-name {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: block;
        }

        .val-green { color: var(--accent-green); }
        .val-red { color: var(--accent-red); }

        .iv-badge {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .iv-low { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .iv-med { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        .iv-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        .range-container {
            position: relative;
            width: 100%;
            height: 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            overflow: visible;
        }

        .range-track {
            position: absolute;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red) 0%, var(--accent-orange) 50%, var(--accent-green) 100%);
            border-radius: 3px;
            width: 100%;
        }

        .range-marker {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        .status-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">Dow 30 <span>MarketPulse</span></div>
        <div class="live-badge">
            <div class="live-dot"></div>
            LIVE
        </div>
    </header>

    <div class="dashboard-grid">
        
        <aside class="controls-panel">
            <div class="control-group">
                <label class="control-label">
                    <span>üìâ Max Drop</span>
                    <span class="slider-value" id="dropValue">0%</span>
                </label>
                <input type="range" id="dropSlider" min="0" max="20" value="0" step="0.5">
            </div>

            <div class="control-group">
                <label class="control-label">
                    <span>üìä Min Volatility</span>
                    <span class="slider-value" id="ivValue">0%</span>
                </label>
                <input type="range" id="ivSlider" min="0" max="10" value="0" step="0.1">
            </div>

            <div class="control-group">
                <label class="control-label">Market Cap</label>
                <select id="marketCapSelect">
                    <option value="all">All Sizes</option>
                    <option value="large">Large (>100B)</option>
                    <option value="mid">Mid (10-100B)</option>
                    <option value="small">Small (<10B)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Timeframe</label>
                <select id="timeframeSelect">
                    <option value="1D">1 Day</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Filter Symbol</label>
                <input type="text" id="symbolInput" class="search-input" placeholder="e.g. AAPL" maxlength="5">
            </div>

            <button id="refreshBtn" class="btn-refresh">üîç Fetch Live Data</button>
            
            <div class="status-text" id="statusText">Ready - Click to load live data</div>
        </aside>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìà Dow 30 Stocks</h2>
                <span class="status-text">Results: <strong id="resultCount">0</strong></span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th data-key="symbol">Symbol <span class="sort-icon"></span></th>
                            <th data-key="price" style="text-align: right;">Live Price <span class="sort-icon"></span></th>
                            <th data-key="change" class="active-sort" style="text-align: right;">% Change <span class="sort-icon">‚ñ≤</span></th>
                            <th data-key="iv" style="text-align: center;">Day Volatility <span class="sort-icon"></span></th>
                            <th data-key="range">52 Week Range <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center; padding:40px; color: var(--text-muted);">
                            Click <strong style="color: var(--accent-blue);">Fetch Live Data</strong> to load
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // CONFIGURATION - UPDATE THIS!
        // ==========================================
        
        // Cloudflare Worker proxy URL
        const WORKER_URL = 'https://stock-api-proxy.george-a1c.workers.dev';
        
        // Your paid API key
        const API_KEY = 'CsC37moTEOy5wF0yLpwBjDZJorOAaPXD';
        const BASE_URL = 'https://financialmodelingprep.com/api/v3';
        
        const DOW30_SYMBOLS = [
            'AAPL', 'MSFT', 'JPM', 'V', 'UNH', 'HD', 'PG', 'JNJ', 'DIS', 'MA',
            'NVDA', 'BAC', 'XOM', 'PFE', 'CSCO', 'ADBE', 'CRM', 'NKE', 'MRK',
            'WMT', 'KO', 'CVX', 'TMO', 'ABBV', 'PEP', 'LLY', 'COST', 'ACN', 'AVGO', 'DHR'
        ];

        // ==========================================
        // STATE & DOM REFERENCES
        // ==========================================
        let marketData = [];
        let sortState = { key: 'change', direction: 'asc' };

        const tbody = document.getElementById('tableBody');
        const dropSlider = document.getElementById('dropSlider');
        const ivSlider = document.getElementById('ivSlider');
        const marketCapSelect = document.getElementById('marketCapSelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const symbolInput = document.getElementById('symbolInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const resultCount = document.getElementById('resultCount');
        const statusText = document.getElementById('statusText');
        const tableHeaders = document.querySelectorAll('th[data-key]');

        dropSlider.addEventListener('input', e => {
            document.getElementById('dropValue').textContent = `${e.target.value}%`;
        });
        ivSlider.addEventListener('input', e => {
            document.getElementById('ivValue').textContent = `${e.target.value}%`;
        });

        // ==========================================
        // API FUNCTIONS
        // ==========================================

        async function fetchMarketData() {
            statusText.textContent = 'Fetching live data from API...';
            
            const symbolsParam = DOW30_SYMBOLS.join(',');
            const apiUrl = `${BASE_URL}/quote/${symbolsParam}?apikey=${API_KEY}`;
            const proxyUrl = `${WORKER_URL}?url=${encodeURIComponent(apiUrl)}`;
            
            console.log('Fetching via Worker:', proxyUrl);
            
            const response = await fetch(proxyUrl);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Worker returned ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error('API returned no data');
            }
            
            console.log('‚úì Received', data.length, 'stocks');
            statusText.textContent = `‚úì Live data loaded at ${new Date().toLocaleTimeString()}`;
            
            return data;
        }

        function transformData(data) {
            return data.map(stock => ({
                symbol: stock.symbol,
                name: stock.name || stock.symbol,
                price: stock.price || 0,
                change: stock.changesPercentage || 0,
                volume: stock.volume || 0,
                marketCap: stock.marketCap || 0,
                yearHigh: stock.yearHigh || stock.price,
                yearLow: stock.yearLow || stock.price,
                dayHigh: stock.dayHigh || stock.price,
                dayLow: stock.dayLow || stock.price,
                iv: stock.dayHigh && stock.dayLow && stock.price 
                    ? ((stock.dayHigh - stock.dayLow) / stock.price) * 100 
                    : 0,
                timeframes: {}
            }));
        }

        async function refreshMarketData() {
            try {
                const apiData = await fetchMarketData();
                marketData = transformData(apiData);
                await filterAndRender();
            } catch (error) {
                console.error('Error:', error);
                statusText.innerHTML = `<span style="color: var(--accent-red);">‚ö† ${error.message}</span>`;
                
                const oldError = document.querySelector('.error-message');
                if (oldError) oldError.remove();
                
                const helpDiv = document.createElement('div');
                helpDiv.className = 'error-message';
                helpDiv.innerHTML = `
                    <strong>Error Loading Data:</strong><br>
                    ${error.message}<br><br>
                    Check browser console (F12) for details<br>
                    Verify your API key at financialmodelingprep.com
                `;
                
                statusText.parentElement.appendChild(helpDiv);
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function formatMarketCap(cap) {
            if (!cap) return 'N/A';
            if (cap >= 1e12) return `$${(cap / 1e12).toFixed(1)}T`;
            if (cap >= 1e9) return `$${(cap / 1e9).toFixed(1)}B`;
            if (cap >= 1e6) return `$${(cap / 1e6).toFixed(1)}M`;
            return `$${cap.toFixed(0)}`;
        }

        function initChart() {
            const ctx = document.getElementById('scatterChart').getContext('2d');
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Stocks',
                        data: [],
                        backgroundColor: function(context) {
                            const value = context.raw?.x || 0;
                            return value >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)';
                        },
                        borderColor: function(context) {
                            const value = context.raw?.x || 0;
                            return value >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)';
                        },
                        pointRadius: 6,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    scales: {
                        x: { 
                            title: { display: true, text: '% Change', color: '#94A3B8' }, 
                            grid: { color: '#1E293B' },
                            ticks: { color: '#94A3B8' }
                        },
                        y: { 
                            title: { display: true, text: 'Daily Volatility %', color: '#94A3B8' }, 
                            beginAtZero: true, 
                            grid: { color: '#334155' },
                            ticks: { color: '#94A3B8' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (!context.raw) return '';
                                    return `${context.raw.symbol}: ${context.raw.x.toFixed(2)}% (Vol: ${context.raw.y.toFixed(2)}%)`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        function renderTable(data) {
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No stocks match filters</td></tr>`;
                return;
            }

            data.forEach(stock => {
                const rangeTotal = stock.yearHigh - stock.yearLow;
                const safeRange = rangeTotal === 0 ? 1 : rangeTotal;
                const position = ((stock.price - stock.yearLow) / safeRange) * 100;
                const clampedPos = Math.max(0, Math.min(100, position));

                let ivClass = 'iv-low';
                if(stock.iv > 1.5) ivClass = 'iv-med';
                if(stock.iv > 3.0) ivClass = 'iv-high';
                
                const changeColor = stock.change >= 0 ? 'val-green' : 'val-red';
                const sign = stock.change > 0 ? '+' : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="ticker-cell">${stock.symbol}</div>
                        <span class="company-name">${stock.name}</span>
                    </td>
                    <td style="text-align: right;">$${stock.price.toFixed(2)}</td>
                    <td style="text-align: right;" class="${changeColor}">${sign}${stock.change.toFixed(2)}%</td>
                    <td style="text-align: center;">
                        <span class="iv-badge ${ivClass}">${stock.iv.toFixed(2)}%</span>
                    </td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94A3B8; margin-bottom:2px;">
                            <span>L: ${stock.yearLow.toFixed(0)}</span>
                            <span>${formatMarketCap(stock.marketCap)}</span>
                            <span>H: ${stock.yearHigh.toFixed(0)}</span>
                        </div>
                        <div class="range-container">
                            <div class="range-track"></div>
                            <div class="range-marker" style="left: ${clampedPos}%"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterAndRender() {
            const filterTerm = symbolInput.value.toUpperCase().trim();
            const minDrop = parseFloat(dropSlider.value);
            const minIV = parseFloat(ivSlider.value);
            const capType = marketCapSelect.value;

            let filtered = [...marketData];

            if (filterTerm.length > 0) {
                filtered = filtered.filter(s => s.symbol.includes(filterTerm));
            }

            filtered = filtered.filter(stock => {
                const meetsDrop = stock.change <= (minDrop === 0 ? 1000 : minDrop);
                const meetsIV = stock.iv >= minIV;
                
                let meetsCap = true;
                if(stock.marketCap) {
                    const capB = stock.marketCap / 1000000000;
                    if(capType === 'large') meetsCap = capB > 100;
                    if(capType === 'mid') meetsCap = capB >= 10 && capB <= 100;
                    if(capType === 'small') meetsCap = capB < 10;
                }

                return meetsDrop && meetsIV && meetsCap;
            });

            filtered.sort((a, b) => {
                let valA = a[sortState.key];
                let valB = b[sortState.key];

                if (sortState.key === 'range') {
                    const rA = (a.yearHigh - a.yearLow) || 1;
                    valA = (a.price - a.yearLow) / rA;
                    const rB = (b.yearHigh - b.yearLow) || 1;
                    valB = (b.price - b.yearLow) / rB;
                }

                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            resultCount.textContent = filtered.length;
            renderTable(filtered);
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        tableHeaders.forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.direction = key === 'change' ? 'asc' : 'desc';
                }
                tableHeaders.forEach(h => {
                    h.classList.remove('active-sort');
                    h.querySelector('.sort-icon').textContent = '';
                });
                th.classList.add('active-sort');
                th.querySelector('.sort-icon').textContent = sortState.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                filterAndRender();
            });
        });

        refreshBtn.addEventListener('click', async () => {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Fetching...';
            
            await refreshMarketData();
            
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîç Fetch Live Data';
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================
        // Chart and automatic data loading removed - click Fetch Data to load

    </script>
</body>
</html>
