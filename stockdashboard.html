<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dow 30 MarketPulse - Real-Time Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --text-main: #F1F5F9;
            --text-muted: #94A3B8;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-blue: #3B82F6;
            --accent-orange: #F59E0B;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span { color: var(--accent-blue); }

        .live-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }

        /* Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100%;
            overflow: hidden;
        }

        /* Controls Sidebar */
        .controls-panel {
            grid-row: 1 / -1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .slider-value { color: var(--accent-blue); font-weight: 600; }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-blue);
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            margin-top: -6px; 
        }
        
        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
        }

        select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
        }

        /* Search Input Styles */
        .search-container {
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .search-btn {
            background: var(--bg-hover);
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 12px;
            cursor: not-allowed;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .btn-refresh {
            background: var(--bg-hover);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            margin-top: auto;
        }

        .btn-refresh:hover { background: #475569; }

        /* Main Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }

        /* Table Styles */
        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            color: var(--text-muted);
            padding: 10px 0;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        th:hover {
            color: var(--text-main);
            background: var(--bg-hover);
        }

        th.active-sort {
            color: var(--accent-blue);
        }

        td {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .ticker-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        
        .company-name {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-weight: 400;
        }

        .val-red { color: var(--accent-red); }
        .val-green { color: var(--accent-green); }
        
        /* 52 Week Range Bar */
        .range-container {
            width: 100px;
            position: relative;
        }
        
        .range-track {
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            width: 100%;
            margin-top: 6px;
        }
        
        .range-marker {
            width: 8px;
            height: 8px;
            background: var(--text-main);
            border-radius: 50%;
            position: absolute;
            top: 4px;
            transform: translateX(-50%);
        }

        .iv-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .iv-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .iv-med { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        .iv-low { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }

        /* Grid Placement */
        .top-losers-section {
            grid-column: 2 / span 2;
            grid-row: 2;
        }

        .chart-section {
            grid-column: 2 / span 2;
            grid-row: 1;
            min-height: 300px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--bg-hover); border-radius: 3px; }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
            }
            
            body { height: auto; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-blue);">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            Market<span>Pulse</span> <span style="font-size:0.8em; margin-left:10px; color:#94A3B8;">Dow 30 Edition</span>
        </div>
        <div class="live-badge">
            <div class="live-dot"></div>
            <span id="connectionStatus">LIVE CONNECTION</span>
        </div>
    </header>

    <div class="dashboard-grid">
        <aside class="controls-panel">
            <h3>Scanner Settings</h3>
            
            <div class="control-group">
                <label class="control-label">Filter Symbols</label>
                <div class="search-container">
                    <input type="text" id="symbolInput" class="search-input" placeholder="Filter list...">
                </div>
            </div>

            <div style="height: 1px; background: var(--border); margin: 10px 0;"></div>

            <div class="control-group">
                <label class="control-label">
                    Min. % Drop (Day)
                    <span class="slider-value" id="dropVal">-2%</span>
                </label>
                <input type="range" id="dropSlider" min="-25" max="0" value="-2" step="0.5">
            </div>

            <div class="control-group">
                <label class="control-label">
                    Min. Volatility (High/Low Spread)
                    <span class="slider-value" id="ivVal">1.5%</span>
                </label>
                <input type="range" id="ivSlider" min="0" max="10" value="1.5" step="0.5">
            </div>

            <div class="control-group">
                <label class="control-label">Timeframe</label>
                <select id="timeframeSelect">
                    <option value="1D">1D (Today - Live)</option>
                    <option value="5D">5D (1 Week)</option>
                    <option value="1M">1M (1 Month)</option>
                    <option value="6M">6M (6 Months)</option>
                    <option value="YTD">YTD</option>
                    <option value="1Y">1Y (1 Year)</option>
                    <option value="5Y">5Y (5 Years)</option>
                    <option value="MAX">MAX</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Market Cap</label>
                <select id="marketCapSelect">
                    <option value="all">All Caps</option>
                    <option value="large">Large Cap (> $100B)</option>
                    <option value="mid">Mid Cap ($10B - $100B)</option>
                    <option value="small">Small Cap (< $10B)</option>
                </select>
            </div>

            <button class="btn-refresh" id="refreshBtn">Force Refresh</button>
        </aside>

        <section class="card chart-section">
            <div class="card-header">
                <div class="card-title">Volatility Map (Daily Volatility vs. % Change)</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">High Volatility + High Drop = Oversold?</div>
            </div>
            <div style="position: relative; height: 100%; width: 100%;">
                <canvas id="volatilityChart"></canvas>
            </div>
        </section>

        <section class="card top-losers-section">
            <div class="card-header">
                <div class="card-title">Market Leaders & Losers</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Showing: <span id="resultCount">0</span></div>
            </div>
            <div class="table-container">
                <table id="losersTable">
                    <thead>
                        <tr>
                            <th width="20%" data-key="symbol">Symbol <span class="sort-icon"></span></th>
                            <th width="15%" style="text-align: right;" data-key="price">Live Price <span class="sort-icon"></span></th>
                            <th width="15%" style="text-align: right;" data-key="change" class="active-sort">% Change <span class="sort-icon">▲</span></th>
                            <th width="15%" style="text-align: center;" data-key="iv">Day Volatility <span class="sort-icon"></span></th>
                            <th width="35%" data-key="range">52 Week Range (Position) <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // ==========================================
        // 1. CONFIG & STATE
        // ==========================================
        const API_KEY = 'CsC37moTEOy5wF0yLpwBjDZJorOAaPXD';
        
        // STRICT DOW 30 LIST (As of Late 2024/2025)
        // Includes: NVDA (Replaced INTC), AMZN (Replaced WBA), SHW (Replaced DOW)
        const DOW_30_SYMBOLS = "AAPL,AMGN,AXP,AMZN,BA,CAT,CRM,CSCO,CVX,DIS,GS,HD,HON,IBM,JNJ,JPM,KO,MCD,MMM,MRK,MSFT,NKE,NVDA,PG,SHW,TRV,UNH,V,VZ,WMT";

        let marketData = []; // This will hold our "Master" data with cached histories
        let sortState = { key: 'change', direction: 'asc' };
        let pollingInterval = null;

        // ==========================================
        // 2. DATA FETCHING ENGINE
        // ==========================================

        function formatMarketCap(cap) {
            if (!cap) return "N/A";
            if (cap >= 1e12) return (cap / 1e12).toFixed(2) + "T";
            if (cap >= 1e9) return (cap / 1e9).toFixed(2) + "B";
            if (cap >= 1e6) return (cap / 1e6).toFixed(2) + "M";
            return cap.toLocaleString();
        }

        function calculateDayVol(high, low, price) {
            if(!high || !low || !price) return 0;
            return ((high - low) / price) * 100;
        }

        // Fetch Batch Quotes (Real Time)
        async function fetchLiveQuotes(symbols) {
            const statusDot = document.getElementById('connectionStatus');
            try {
                if(statusDot) statusDot.style.color = '#3B82F6'; // Pulse Blue
                
                // FIXED: Changed from /stable/quote?symbol= to /api/v3/quote/
                const response = await fetch(`https://financialmodelingprep.com/api/v3/quote/${symbols}?apikey=${API_KEY}`);
                
                if (!response.ok) {
                    console.error(`API HTTP Error: ${response.status}`);
                    if(statusDot) statusDot.style.color = '#EF4444'; 
                    return [];
                }

                const data = await response.json();
                
                // CRITICAL CHECK: Ensure array to prevent crash
                if (!Array.isArray(data)) {
                    console.error("API Error (Limit or format):", data);
                    if(statusDot) statusDot.style.color = '#EF4444';
                    return [];
                }

                if(statusDot) statusDot.style.color = '#10B981'; // Green
                return data;

            } catch (error) {
                console.error("Fetch Error:", error);
                if(statusDot) statusDot.style.color = '#EF4444';
                return [];
            }
        }

        // Fetch Historical Changes
        async function fetchHistoricalData(symbol) {
            try {
                // FIXED: Changed from /stable/stock-price-change?symbol= to /api/v3/stock-price-change/
                const response = await fetch(`https://financialmodelingprep.com/api/v3/stock-price-change/${symbol}?apikey=${API_KEY}`);
                const data = await response.json();
                if(Array.isArray(data) && data.length > 0) return data[0];
                return null;
            } catch (e) { return null; }
        }

        // CORE UPDATE FUNCTION (SMART MERGE)
        async function refreshMarketData() {
            const liveItems = await fetchLiveQuotes(DOW_30_SYMBOLS);
            
            if(liveItems.length > 0) {
                // We need to merge new live data into our existing 'marketData' array
                // to preserve any historical timeframes we have already fetched.
                
                liveItems.forEach(newItem => {
                    const volatility = calculateDayVol(newItem.dayHigh, newItem.dayLow, newItem.price);
                    
                    // Check if we already have this stock in memory
                    const existingStock = marketData.find(s => s.symbol === newItem.symbol);

                    if (existingStock) {
                        // UPDATE existing record (Keep cached timeframes)
                        existingStock.price = newItem.price;
                        existingStock.change = newItem.changesPercentage;
                        existingStock.dayLow = newItem.dayLow;
                        existingStock.dayHigh = newItem.dayHigh;
                        existingStock.yearLow = newItem.yearLow;
                        existingStock.yearHigh = newItem.yearHigh;
                        existingStock.iv = volatility;
                        existingStock.timeframes['1D'] = { change: newItem.changesPercentage };
                    } else {
                        // CREATE new record
                        marketData.push({
                            symbol: newItem.symbol,
                            name: newItem.name,
                            price: newItem.price,
                            change: newItem.changesPercentage,
                            dayLow: newItem.dayLow,
                            dayHigh: newItem.dayHigh,
                            yearLow: newItem.yearLow,
                            yearHigh: newItem.yearHigh,
                            marketCap: newItem.marketCap,
                            iv: volatility,
                            timeframes: {
                                '1D': { change: newItem.changesPercentage }
                            }
                        });
                    }
                });
                
                filterAndRender();
            }
        }

        // ==========================================
        // 3. DASHBOARD UI LOGIC
        // ==========================================
        
        const dropSlider = document.getElementById('dropSlider');
        const dropVal = document.getElementById('dropVal');
        const ivSlider = document.getElementById('ivSlider');
        const ivVal = document.getElementById('ivVal');
        const marketCapSelect = document.getElementById('marketCapSelect');
        const timeframeSelect = document.getElementById('timeframeSelect');
        const tbody = document.querySelector('#losersTable tbody');
        const resultCount = document.getElementById('resultCount');
        const refreshBtn = document.getElementById('refreshBtn');
        const symbolInput = document.getElementById('symbolInput');
        const tableHeaders = document.querySelectorAll('#losersTable th[data-key]');

        dropSlider.addEventListener('input', (e) => dropVal.textContent = `${e.target.value}%`);
        ivSlider.addEventListener('input', (e) => ivVal.textContent = `${e.target.value}%`);

        let scatterChart;

        function initChart() {
            const ctx = document.getElementById('volatilityChart').getContext('2d');
            Chart.defaults.color = '#94A3B8';
            Chart.defaults.borderColor = '#334155';

            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Stocks',
                        data: [],
                        backgroundColor: (context) => {
                            const val = context.raw?.x;
                            return val < -2 ? '#EF4444' : (val < 0 ? '#F87171' : '#10B981');
                        },
                        pointRadius: 6,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    scales: {
                        x: { title: { display: true, text: '% Change' }, grid: { color: '#1E293B' } },
                        y: { title: { display: true, text: 'Daily Volatility %' }, beginAtZero: true, grid: { color: '#334155' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.symbol}: ${context.raw.x.toFixed(2)}% (Vol: ${context.raw.y.toFixed(2)}%)`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        function renderTable(data, selectedTimeframe) {
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">Scanning Market Data...</td></tr>`;
                return;
            }

            data.forEach(stock => {
                let currentChange = 0;
                if(selectedTimeframe === '1D') {
                    currentChange = stock.change;
                } else if (stock.timeframes && stock.timeframes[selectedTimeframe]) {
                    currentChange = stock.timeframes[selectedTimeframe].change;
                }

                const rangeTotal = stock.yearHigh - stock.yearLow;
                const safeRange = rangeTotal === 0 ? 1 : rangeTotal;
                const position = ((stock.price - stock.yearLow) / safeRange) * 100;
                const clampedPos = Math.max(0, Math.min(100, position));

                let ivClass = 'iv-low';
                if(stock.iv > 1.5) ivClass = 'iv-med';
                if(stock.iv > 3.0) ivClass = 'iv-high';
                
                const changeColor = currentChange >= 0 ? 'val-green' : 'val-red';
                const sign = currentChange > 0 ? '+' : '';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="ticker-cell">${stock.symbol}</div>
                        <span class="company-name" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${stock.name}</span>
                    </td>
                    <td style="text-align: right;">$${stock.price.toFixed(2)}</td>
                    <td style="text-align: right;" class="${changeColor}">${sign}${currentChange ? currentChange.toFixed(2) : '0.00'}%</td>
                    <td style="text-align: center;">
                        <span class="iv-badge ${ivClass}">${stock.iv.toFixed(2)}%</span>
                    </td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#94A3B8; margin-bottom:2px;">
                            <span>L: ${stock.yearLow ? stock.yearLow.toFixed(0) : 'N/A'}</span>
                            <span>${formatMarketCap(stock.marketCap)}</span>
                            <span>H: ${stock.yearHigh ? stock.yearHigh.toFixed(0) : 'N/A'}</span>
                        </div>
                        <div class="range-container">
                            <div class="range-track"></div>
                            <div class="range-marker" style="left: ${clampedPos}%" title="Current Price"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function filterAndRender() {
            const filterTerm = symbolInput.value.toUpperCase().trim();
            const currentTimeframe = timeframeSelect.value; 
            const minDrop = parseFloat(dropSlider.value);
            const minIV = parseFloat(ivSlider.value);
            const capType = marketCapSelect.value;

            let filtered = [...marketData];

            // 1. Local Filter (Dow 30 Only)
            if (filterTerm.length > 0) {
                filtered = filtered.filter(s => s.symbol.includes(filterTerm));
            }

            // 2. Handle History (Lazy Load with Caching)
            if(currentTimeframe !== '1D') {
                for (let stock of filtered) {
                    // API OPTIMIZATION: Only fetch if we don't have it yet
                    if (!stock.timeframes[currentTimeframe]) {
                        const hist = await fetchHistoricalData(stock.symbol);
                        if(hist) {
                            stock.timeframes['5D'] = { change: hist['5D'] };
                            stock.timeframes['1M'] = { change: hist['1M'] };
                            stock.timeframes['6M'] = { change: hist['6M'] };
                            stock.timeframes['YTD'] = { change: hist['ytd'] };
                            stock.timeframes['1Y'] = { change: hist['1Y'] };
                            stock.timeframes['5Y'] = { change: hist['5Y'] };
                            stock.timeframes['MAX'] = { change: hist['max'] };
                        }
                    }
                }
            }

            // 3. Filter Logic
            filtered = filtered.filter(stock => {
                let changeToCheck = stock.change; 
                if(currentTimeframe !== '1D' && stock.timeframes[currentTimeframe]) {
                    changeToCheck = stock.timeframes[currentTimeframe].change;
                }

                const meetsDrop = changeToCheck <= (minDrop === 0 ? 1000 : minDrop);
                const meetsIV = stock.iv >= minIV;
                
                let meetsCap = true;
                if(stock.marketCap) {
                    const capB = stock.marketCap / 1000000000;
                    if(capType === 'large') meetsCap = capB > 100;
                    if(capType === 'mid') meetsCap = capB >= 10 && capB <= 100;
                    if(capType === 'small') meetsCap = capB < 10;
                }

                return meetsDrop && meetsIV && meetsCap;
            });

            // 4. Sort
            filtered.sort((a, b) => {
                let valA, valB;
                
                if (sortState.key === 'change') {
                     valA = currentTimeframe === '1D' ? a.change : (a.timeframes[currentTimeframe]?.change || 0);
                     valB = currentTimeframe === '1D' ? b.change : (b.timeframes[currentTimeframe]?.change || 0);
                } else if (sortState.key === 'range') {
                     const rA = (a.yearHigh - a.yearLow) || 1;
                     valA = (a.price - a.yearLow) / rA;
                     const rB = (b.yearHigh - b.yearLow) || 1;
                     valB = (b.price - b.yearLow) / rB;
                } else {
                    valA = a[sortState.key];
                    valB = b[sortState.key];
                }

                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            resultCount.textContent = filtered.length;
            renderTable(filtered, currentTimeframe);

            const chartData = filtered.map(s => ({
                x: currentTimeframe === '1D' ? s.change : (s.timeframes[currentTimeframe]?.change || 0),
                y: s.iv,
                symbol: s.symbol
            }));
            scatterChart.data.datasets[0].data = chartData;
            scatterChart.options.scales.x.title.text = `% Change (${currentTimeframe})`;
            scatterChart.update();
        }

        // ==========================================
        // 4. EVENT LISTENERS
        // ==========================================

        tableHeaders.forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (sortState.key === key) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.direction = key === 'change' ? 'asc' : 'desc';
                }
                tableHeaders.forEach(h => {
                    h.classList.remove('active-sort');
                    h.querySelector('.sort-icon').textContent = '';
                });
                th.classList.add('active-sort');
                th.querySelector('.sort-icon').textContent = sortState.direction === 'asc' ? '▲' : '▼';
                filterAndRender();
            });
        });

        // Filter input (Local only)
        symbolInput.addEventListener('keyup', filterAndRender);

        [dropSlider, ivSlider, marketCapSelect, timeframeSelect].forEach(el => {
            el.addEventListener('change', filterAndRender);
        });

        refreshBtn.addEventListener('click', () => {
            symbolInput.value = '';
            refreshMarketData();
            startPolling();
        });

        // ==========================================
        // 5. INITIALIZATION
        // ==========================================

        function startPolling() {
            if(pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(refreshMarketData, 15000);
        }

        initChart();
        refreshMarketData(); 
        startPolling(); 

    </script>
</body>
</html>